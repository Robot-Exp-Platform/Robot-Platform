# 02-1 任务记录

## 相关关键词

> recoder 通讯 数据库

## 任务目标

实验做完总是要有数据的，整理保存这些数据是相当重要的工作，这些数据将作为学术成果的关键证据，也是后续工作的重要参考。
同时，数据的记录往往是时序的、多维的，每次打开文件写入数据在关闭文件相对较慢，而保持文件打开并储存文件指针则不利于多线程的数据记录。
选择一种数据库或者高效的数据记录方式也许是好的建议，
同时，我们不希望数据记录影响到主循环的运行，所以需要一个高效的数据记录方式。

一些数据会被直接广播到通讯网络，比如robot状态，控制器的控制指令，规划器发布的轨迹点，task_manager发布的目标点等等。
有没有不会被广播的数据呢？确实有，大多是debug数据，这些数据作为实验记录无关紧要，但是在系统复杂时很有可能会用到。

由于不同节点具有不一样的循环频率，每条数据的发布确实需要一个时间戳作为标记。

可以考虑使用 std::BufWriter 来写入数据。
考虑实现一个过程宏，在写入数据的同时自动记录时间戳。

如果你的应用程序支持异步 I/O，你可以使用 tokio 的 AsyncFile 或 async-std 的异步文件操作来进一步提高效率。使用异步 I/O 可以避免阻塞主线程，并能更好地处理高并发的文件写入。

## 任务方案

目前思路整理下来有三种方案。直接在循环内打开文件输出的行为必然是不行的，文件本身的打开销毁可能会消耗不小的时间。

1. 使用数据库记录，可选的数据库在 <https://zhuanlan.zhihu.com/p/688906139> 可见。使用数据库的好处在于我们不需要处理数据文件结构，只需要将标记好的数据写入数据库即可，尤其推荐时序数据库。
2. 采用 recoder 线程专门用于记录线程，将需要被记录的数据打上时间戳后通过队列传递给 recoder 线程，recoder 区分数据类型并写入文件。这种方法到是没有性能只忧，但是会显著增加代码复杂度和线程复杂度。
3. 使用 std::BufWriter 来写入数据，这种方案可以大大减小代码复杂度（目前代码已经很是复杂了）,同时采用BufWriter 也不用担心过多的性能损耗。

## 实验数据结构

如果采用 2，3 方案，那么每次实验中产生的数据结构如下格式，而不需要在人为搬迁数据。其中 `${任务标签}` 在`config.json`中，`${task_标签}` 在 `task.json` 中。

- /data
  - Exp_${实验标签}
    - config.json
      - task_${task_标签}
        - task.json
        - robot_1
        - robot_2
        - ...
      - task_${task_标签}
        - task.json
        - ...
  - Exp_${任务标签}
    - ...

同时在 .gitignore 中将除了后缀为 json 文件的文件夹全部忽略，避免git管理数据过多，同时，在包含 config.json 和 task.json 文件的情况下，我们可以完全复现整个实验。
